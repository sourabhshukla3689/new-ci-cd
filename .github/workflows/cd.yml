name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    branches: [main, develop]
    types:
      - completed

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Deploy to Development
  deploy-dev:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'develop'
    environment: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Deploy to development
        run: |
          echo "üöÄ Deploying to development environment..."
          echo "üì¶ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:develop-${{ github.event.workflow_run.head_sha }}"
          echo "üîç Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "‚úÖ Development deployment completed!"

  # Deploy to Production
  deploy-prod:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Deploy to production
        run: |
          echo "üöÄ Deploying to production environment..."
          echo "üì¶ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-${{ github.event.workflow_run.head_sha }}"
          echo "üîç Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "‚úÖ Production deployment completed!"
          
      - name: Post-deployment verification
        run: |
          echo "üîç Running post-deployment checks..."
          echo "‚úÖ All checks passed!"

  # Rollback capability
  rollback:
    runs-on: ubuntu-latest
    if: failure() && (github.event.workflow_run.head_branch == 'main')
    environment: production
    steps:
      - name: Rollback deployment
        run: |
          echo "‚ö†Ô∏è Deployment failed, initiating rollback..."
          echo "üîÑ Rolling back to previous stable version..."
          echo "‚úÖ Rollback completed successfully!"